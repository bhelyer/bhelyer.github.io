function seekAi(){var e=this,t=this.canSee(Game.player);t&&!this.seenPlayer&&Log.add(function(){return MessageStrings.get(MSG_A_MOANS,e.name)});if(t){var n=this,r=!0;function i(e,t){return r?(r=!1,!0):(n.actions.push(new Action("move",n.x,n.y,e,t)),!1)}line(n.x,n.y,Game.player.x,Game.player.y,i)}this.seenPlayer=t}function creatureCanSee(e){function i(e,i){r--;if(r<0)return t=!1;var s=n.dungeon.tileAt(e,i);return TileAttrs[s.id].transparent?!0:t=!1}var t=!0,n=this,r=CreatureAttrs[n.id].sightRange;return line(this.x,this.y,e.x,e.y,i),t}function Creature(e){this.id=e,this.actions=new Array,this.canSee=creatureCanSee;var t=CreatureAttrs[e];this.name=t.name,this.hp=this.maxHp=(new Dice(t.initialMaxHP)).roll(),this.str=(new Dice(t.initialStrength)).roll(),this.def=(new Dice(t.initialDefence)).roll();switch(e){case"seeker":this.ai=seekAi,this.seenPlayer=!1;break;default:}}function Action(e,t,n,r,i){this.id=e,this.a=t,this.b=n,this.c=r,this.d=i}function Dice(e){var t=new Object,n=e.split("d");return n[0].length===0&&(n[0]="1"),t.numberOfDice=parseInt(n[0],10),n[1].indexOf("+")!=-1?t.modifier=parseInt(n[1].substr(n[1].indexOf("+")+1),10):n[1].indexOf("-")!=-1?t.modifier=parseInt(n[1].substr(n[1].indexOf("-")),10):t.modifier=0,t.sides=parseInt(n[1],10),t.roll=diceRoll,t}function diceRoll(){var e=0;for(var t=0,n=this.numberOfDice;t<n;++t)e+=getRandomInt(1,this.sides+1);return e+this.modifier}function simpleDungeonGenerator(){function f(){o=getRandomInt(1,a.width-1),u=getRandomInt(1,a.height-1)}function l(e){do f();while(!e(o,u))}function c(e,t){var n=a.tileAt(e,t);if(n.id!="wall")return!1;var r=a.tileAt(e-1,t),i=a.tileAt(e+1,t),s=a.tileAt(e,t-1),o=a.tileAt(e,t+1);return r&&r.id==="floor"||i&&i.id==="floor"||s&&s.id==="floor"||o&&o.id==="floor"}function h(){l(c);var e=new Array(4);e[0]=a.tileAt(o-1,u),e[1]=a.tileAt(o+1,u),e[2]=a.tileAt(o,u-1),e[3]=a.tileAt(o,u+1);var t=getRandomInt(6,12);e:for(var n=0,r=e.length;n<r;n++){var i=e[n],s=t;while(s>0){function f(e){return i.x<=0||i.x>=a.width||i.y<=0||i.y>=a.height}if(!i||i.id!="wall"||f(i))break;switch(n){case 0:var h=a.tileAt(i.x,i.y-1),p=a.tileAt(i.x,i.y+1);if(!h||h.id=="floor"||!p||p.id=="floor")break e;i=a.tileAt(i.x-1,i.y);break;case 1:var h=a.tileAt(i.x,i.y-1),p=a.tileAt(i.x,i.y+1);if(!h||h.id=="floor"||!p||p.id=="floor")break e;i=a.tileAt(i.x+1,i.y);break;case 2:var h=a.tileAt(i.x-1,i.y),p=a.tileAt(i.x+1,i.y);if(!h||h.id=="floor"||!p||p.id=="floor")break e;i=a.tileAt(i.x,i.y-1);break;case 3:var h=a.tileAt(i.x-1,i.y),p=a.tileAt(i.x+1,i.y);if(!h||h.id=="floor"||!p||p.id=="floor")break e;i=a.tileAt(i.x,i.y+1)}s--}if(s==0){s=t;while(s>0){a.tiles[u*a.width+o].id="floor";switch(n){case 0:o--;break;case 1:o++;break;case 2:u--;break;case 3:u++}s--}return 1}}return 0}function p(e,t,n,r){if(n<e){var i=e;e=n,n=i}if(r<t){var i=t;t=r,r=i}for(var s=t;s<=r;s++)for(var o=e;o<=n;o++){if(o<=0||o>=a.width||s<=0||s>=a.height)return!1;if(a.tiles[s*a.width+o].id=="floor")return!1}return!0}function d(e,t,n){var r=new Object;switch(e){case 0:r.x1=o-(Math.floor(t/2)+1),r.x2=o-1,r.y1=u-Math.floor(n/2),r.y2=u;break;case 1:r.x1=o-1,r.x2=o-(Math.floor(t/2)+1),r.y1=u-Math.floor(n/2),r.y2=u-1;break;case 2:r.x1=o-Math.floor(t/2),r.x2=o-1,r.y1=u-(Math.floor(n/2)+1),r.y2=u-1;break;case 3:r.x1=o-Math.floor(t/2),r.x2=o-1,r.y1=u-1,r.y2=u-(Math.floor(n/2)+1)}return r}function v(){l(c);var e=getRandomInt(5,8),t=getRandomInt(4,6);for(var n=0;n<4;n++){var r=d(n,e,t);if(p(r.x1,r.y1,r.x2,r.y2))return a.digRoom(r.x1,r.y1,r.x2,r.y2,"floor"),a.tiles[u*a.width+o].id="floor",1}return 0}function m(){var e=getRandomInt(1,101);switch(!0){case e>=1&&e<83:return h();default:return v()}return 0}this.fill("wall");var e=Math.floor(this.width/2),t=Math.floor(this.height/2),n=getRandomInt(e-8,e+5),r=getRandomInt(n+3,n+8),i=getRandomInt(t-3,t+3),s=getRandomInt(i+3,i+6);this.digRoom(n,i,r,s,"floor");var o,u,a=this,g=60;while(g>0)g-=m();var y=this.getEmptyTile();y.id="stairsup"}function dungeonDraw(){var e='<div class="dungeon">',t="";for(var n=0;n<this.height;n++){e+='<span class="rowstart">';for(var r=0;r<this.width;r++){var i=this.tiles[n*this.width+r];if(i.creature===null){var s=i.id;if(t===""||t!=s)e+='</span><span class="'+s+'" onmouseover="onMouseOver(\''+s+"'); return false;\">",t=s;e+=TileAttrs[s].c}else{var o=i.creature.id;if(t===""||t!=o)e+='</span><span class="'+o+'" onmouseover="onMouseOver(\''+o+"'); return false;\">",t=o;e+=CreatureAttrs[o].c}}e+="</span><br>",t=""}document.getElementById("dungeon").innerHTML=e}function dungeonTileAt(e,t){return e<0||e>=this.width||t<0||t>=this.height?undefined:this.tiles[t*this.width+e]}function dungeonDigRoom(e,t,n,r,i){if(n<e){var s=e;e=n,n=s}if(r<t){var s=t;t=r,r=s}for(var o=t;o<=r;o++)for(var u=e;u<=n;u++)this.tiles[o*this.width+u]=new Tile(i,u,o)}function dungeonFill(e){this.tiles=new Array(this.width*this.height),this.digRoom(0,0,this.width-1,this.height-1,e)}function dungeonGetEmptyTile(){function t(t,n){var r=e.tileAt(t,n);return r.id==="floor"&&r.creature==null}var e=this;do var n=getRandomInt(1,this.width-1),r=getRandomInt(1,this.height-1),i=t(n-1,r-1)&&t(n,r-1)&&t(n+1,r-1)&&t(n-1,r)&&t(n,r)&&t(n+1,r)&&t(n-1,r+1)&&t(n,r+1)&&t(n+1,r+1);while(!i);return e.tileAt(n,r)}function DungeonFloor(e,t,n){this.width=e,this.height=t,this.creatures=new Array,this.generate=n,this.draw=dungeonDraw,this.tileAt=dungeonTileAt,this.digRoom=dungeonDigRoom,this.fill=dungeonFill,this.getEmptyTile=dungeonGetEmptyTile,this.generate()}function FovMap(e){this.dungeon=e}function Item(e){this.id=e}function populateDungeon(){addCreature(Game.dungeon,Game.dungeon.getEmptyTile(),Game.player);var e=10;while(e-->0){var t=Game.dungeon.getEmptyTile();addCreature(Game.dungeon,t,new Creature("seeker"))}}function onMouseOver(e){switch(e){case"wall":case"floor":Game.info=MSG_INTRO;break;case"player":Game.info=MSG_PLAYERDESC;break;case"seeker":Game.info=MSG_SEEKERDESC;break;default:}}function moveCreature(e,t,n,r){if(t.creature===null)throw new Error("moveCreature(): tried to move creature from empty tile.");var i=t.x+n,s=t.y+r;if(i<0||i>=e.width||s<0||s>=e.height){Log.add(MSG_NO_WALK);return}var o=e.tileAt(i,s);if(o.creature!=null){attackCreature(t.creature,o.creature);return}if(!TileAttrs[o.id].walkable){Log.add(MSG_NO_WALK);return}o.creature=t.creature,t.creature=null,o.creature.x=o.x,o.creature.y=o.y;return}function attackCreature(e,t){Log.add(function(){return MessageStrings.get(MSG_A_ATTACKS_B,e.name,t.name)});var n=Math.floor(e.str/2),r=Math.floor(t.def/2),i=getRandomInt(e.str-n,e.str+n),s=getRandomInt(t.def-r,t.str+r),o=i-s;o<=0?Log.add(function(){return MessageStrings.get(MSG_A_DODGES,t.name)}):(t.hp-=o,Log.add(function(){return MessageStrings.get(MSG_A_RECEIVES_B_DMG,t.name,o)}))}function Tile(e,t,n){this.id=e,this.creature=null,this.items=new Array,this.x=t,this.y=n}function addCreature(e,t,n){e.creatures.push(n),t.creature=n,n.x=t.x,n.y=t.y,n.dungeon=e}function getRandomInt(e,t){return Math.floor(Math.random()*(t-e))+e}function line(e,t,n,r,i){var s=Math.abs(n-e),o=e<n?1:-1,u=Math.abs(r-t),a=t<r?1:-1,f=(s>u?s:-u)/2;while(i(e,t)){if(e===n&&t===r)break;var l=f;l>-s&&(f-=u,e+=o),l<u&&(f+=s,t+=a)}}function getQueryParams(e){e=e.split("+").join(" ");var t={},n,r=/[?&]?([^=]+)=([^&]*)/g;while(n=r.exec(e))t[decodeURIComponent(n[1])]=decodeURIComponent(n[2]);return t}function cap(e){return e.charAt(0).toUpperCase()+e.slice(1)}var CreatureAttrs={player:{c:"@",name:MSG_YOU,sightRange:5,initialMaxHP:"3d10+2",initialStrength:"2d6",initialDefence:"d6"},seeker:{c:"s",name:MSG_SEEKER,sightRange:7,initialMaxHP:"2d6+2",initialStrength:"d6+1",initialDefence:"d4"}},ItemAttrs={oaken_heart:{c:"心",name:MSG_OAKEN_HEART}},Game={fps:12,floor:0,info:MSG_INTRO,over:!1};Game.dungeon=new DungeonFloor(80,25,simpleDungeonGenerator),Game.player=new Creature("player"),populateDungeon(),Game.doAction=function(e){switch(e.id){case"move":var t=this.dungeon.tileAt(e.a,e.b),n=e.c-e.a,r=e.d-e.b;moveCreature(this.dungeon,t,n,r);break;case"doground":var i=this.dungeon.tileAt(Game.player.x,Game.player.y);i.id!="stairsup"?Log.add(MSG_FAIL_DOGROUND):(Game.floor++,Game.dungeon=new DungeonFloor(80,25,simpleDungeonGenerator),populateDungeon(),Log.add(MSG_CLIMB));break;case"wait":break;default:throw new Error("Game.doAction(): unknown id: "+e.id)}},Game.update=function(){if(Game.player.actions.length==0||Game.over)return;for(var e=0;e<Game.dungeon.creatures.length;e++){var t=Game.dungeon.creatures[e];typeof t.ai=="function"&&t.ai(),t.actions.length>0&&(this.doAction(t.actions[0]),t.actions=t.actions.slice(1));if(t.hp<=0){var n=function(e){return function(){return MessageStrings.get(MSG_A_DIES,e)}}(t.name);Log.add(n),Game.dungeon.creatures.splice(e--,1);var r=this.dungeon.tileAt(t.x,t.y);if(r.creature!=t)throw new Error("Game.update: Dungeon and creature disagree on location upon death.");r.creature=null;if(t==Game.player){Game.over=!0;return}}}},Game.draw=function(){MessageStrings.drawOptions(),Log.draw(),Game.dungeon.draw(),document.getElementById("status").innerHTML=MessageStrings.getStatus(this.floor,this.player),document.getElementById("info").innerHTML=MessageStrings.get(Game.info)},Game.input=function(e){if(Game.player.actions.length>0)return;var t=Game.player.x,n=Game.player.y;switch(e.keyCode){case 72:Game.player.actions.push(new Action("move",t,n,t-1,n));break;case 74:Game.player.actions.push(new Action("move",t,n,t,n+1));break;case 75:Game.player.actions.push(new Action("move",t,n,t,n-1));break;case 76:Game.player.actions.push(new Action("move",t,n,t+1,n));break;case 89:Game.player.actions.push(new Action("move",t,n,t-1,n-1));break;case 85:Game.player.actions.push(new Action("move",t,n,t+1,n-1));break;case 66:Game.player.actions.push(new Action("move",t,n,t-1,n+1));break;case 78:Game.player.actions.push(new Action("move",t,n,t+1,n+1));break;case 71:Game.player.actions.push(new Action("doground"));break;case 190:e.shiftKey?Game.player.actions.push(new Action("doground")):Game.player.actions.push(new Action("wait"));break;case 188:e.shiftKey&&Game.player.actions.push(new Action("doground"));break;default:return}e.preventDefault()},Game.run=function(){Game.update(),Game.draw()},Game._intervalId=setInterval(Game.run,1e3/Game.fps),document.addEventListener("keydown",Game.input),document.addEventListener("keyrepeat",Game.input),getQueryParams(document.location.search).lang=="japanese"&&MessageStrings.toggleLanguage();var Log={display_height:10,messages:[]};Log.draw=function(){var e='<div class="log">';for(var t=Log.messages.length-(Log.display_height+1);t<Log.messages.length;t++){var n=t===Log.messages.length-1;n&&(e+='<span class="mostrecentlog">'),t<0?e+="<br>":typeof Log.messages[t]=="function"?e+=Log.messages[t]()+"<br>":e+=MessageStrings.get(Log.messages[t])+"<br>",n&&(e+="</span>")}document.getElementById("log").innerHTML=e},Log.add=function(e){Log.messages.push(e)};var MSG_NONE=-1,MSG_NO_WALK=0,MSG_LANGUAGE=1,MSG_CURRENTLANGUAGE=2,MSG_RETURNTOINDEX=3,MSG_OPPOSITELANGUAGE=4,MSG_FAIL_DOGROUND=5,MSG_CLIMB=6,MSG_INTRO=7,MSG_SEEKERDESC=8,MSG_PLAYERDESC=9,MSG_A_MOANS=10,MSG_SEEKER=11,MSG_FLOOR=12,MSG_HP=13,MSG_STR=14,MSG_DEF=15,MSG_A_ATTACKS_B=16,MSG_YOU=17,MSG_A_RECEIVES_B_DMG=18,MSG_A_DODGES=19,MSG_A_DIES=20,MSG_OAKEN_HEART=21,MessageLanguage={ENGLISH:0,JAPANESE:1},MessageStrings={language:MessageLanguage.ENGLISH},E_INTRO="<p>'Endless Tower', scholars are quick to point out, is a crude rendering from the Seekers' long dead language. A better translation, they say, would be 'Tower to the Endless'. </p><p>Nevertheless, no one has ever reached the top.</p>",J_INTRO="<p>「シーカーの古い死語から『エンドレスなタワー』は雑な翻訳だよ」と学者が早く言います。より良い翻訳は、「終焉へのタワー」だというのです。</p><p>しかし、誰一人タワーの頂上に到達した者はいません。</p>",E_SEEKER="<p>Robed in white, face shrouded. It shuffles towards you. This is a Seeker. Like you they sought answers. Now they are mere thralls to the tower, and see you as an infection to be purged.</p>",J_SEEKER="<p>顔まで覆われたローブを着た人が近づいてきりました。これはシーカーです。あなたごとき、答えを探しました。今タワーに捕らわれます。シーカーが感染とする。</p>";MessageStrings.toggleLanguage=function(){this.language===MessageLanguage.ENGLISH?this.language=MessageLanguage.JAPANESE:this.language=MessageLanguage.ENGLISH},MessageStrings.drawOptions=function(){document.getElementById("langbutton").innerHTML=this.get(MSG_OPPOSITELANGUAGE),document.getElementById("return").innerHTML=this.get(MSG_RETURNTOINDEX)},MessageStrings.get=function(e,t,n){function o(e,n){return typeof n=="undefined"&&(n=" ")," "+e+(t===MSG_YOU?n:"s"+n)}var r=this.language,i=MessageLanguage.ENGLISH,s=MessageLanguage.JAPANESE;switch(e){case MSG_NONE:throw new Error("MessageStrings.get: Tried to retrieve MSG_NONE.");case MSG_NO_WALK:return r==i?"You cannot walk there.":"あなたはそこに歩けない。";case MSG_LANGUAGE:return r==i?"Language":"言語";case MSG_CURRENTLANGUAGE:return r==s?"日本語":"English";case MSG_OPPOSITELANGUAGE:return r==s?"English":"日本語";case MSG_RETURNTOINDEX:return r==i?"Return to index.":"インデックスへ戻る。";case MSG_FAIL_DOGROUND:return r==i?"There's nothing here.":"ここにない。";case MSG_CLIMB:return r==i?"You climb the stairs.":"あなたは階段に上る。";case MSG_INTRO:return r==i?E_INTRO:J_INTRO;case MSG_SEEKERDESC:return r==i?E_SEEKER:J_SEEKER;case MSG_PLAYERDESC:return r==i?"Who are you?":"あなたは誰ですか？";case MSG_A_MOANS:return r==i?cap(this.get(t))+" moans.":this.get(t)+"が唸る。";case MSG_SEEKER:return r==i?"the Seeker":"シーカー";case MSG_FLOOR:return r==i?"Floor":"階段";case MSG_HP:return r==i?"Vitality":"体力";case MSG_STR:return r==i?"Strength":"筋力";case MSG_DEF:return r==i?"Defence":"防御力";case MSG_A_ATTACKS_B:return r==i?cap(this.get(t))+o("attack")+this.get(n)+".":this.get(t)+"が"+this.get(n)+"を攻撃する。";case MSG_YOU:return r==i?"you":"あなた";case MSG_A_RECEIVES_B_DMG:return r==i?cap(this.get(t))+o("receive")+n+" damage.":this.get(t)+"が"+n+"ダメージを受ける。";case MSG_A_DODGES:return r==i?"But "+this.get(t)+o("dodge","."):"でも、"+this.get(t)+"がかわす。";case MSG_A_DIES:return(t==MSG_YOU?'<span id="playerdeath">':"<span>")+(r==i?cap(this.get(t))+o("die","."):this.get(t)+"が死ぬ。")+"</span>";case MSG_OAKEN_HEART:return r==i?"oaken heart":"オークの心臓"}},MessageStrings.getStatus=function(e,t){function r(){return n===MessageLanguage.JAPANESE?e+1:e===0?"G":e}var n=this.language;return'<span class="unit">'+this.get(MSG_FLOOR)+"</span>:"+r()+' <span class="unit">'+this.get(MSG_HP)+"</span>:"+t.hp+"/"+t.maxHp+' <span class="unit">'+this.get(MSG_STR)+"</span>:"+t.str+' <span class="unit">'+this.get(MSG_DEF)+"</span>:"+t.def;var i};var TileAttrs={floor:{walkable:!0,transparent:!0,c:"."},wall:{walkable:!1,transparent:!1,c:"#"},stairsup:{walkable:!0,transparent:!0,c:"<"}};